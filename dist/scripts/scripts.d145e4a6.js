"use strict";angular.module("hyenaAppsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngStorage","firebase","angularMoment","angularFileUpload"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"DashboardCtrl"}).when("/app/new",{templateUrl:"views/new.html",controller:"NewCtrl"}).when("/upload",{template:"",controller:function(){console.log("Upload controller")}}).when("/app/:appId",{templateUrl:"views/app.html",controller:"AppCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]).config(["$httpProvider",function(a){a.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]).constant("FBURL","https://hyena-apps.firebaseio.com/").constant("APIKEY","NDBlZGMyZTNmZWU0YzQzYTkwMGRiZTA5").constant("APIPATH","http://st-studio.unl.edu/hyena_platform/public/api/1.0/").constant("PLATFORM_ROOT","http://st-studio.unl.edu/hyena_platform/public/").constant("angularMomentConfig",{}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}),angular.module("hyenaAppsApp").factory("AppFirebase",["FBURL","$firebase","$firebaseAuth",function(a,b,c){var d=new Firebase(a),e={getRef:function(){return d},getAuthRef:function(){return c(d)},authenticate:function(a){var b=c(d);return b.$authWithCustomToken(a)}};return e}]),angular.module("hyenaAppsApp").controller("ApplicationCtrl",["$rootScope","$scope","$location","$window","$routeParams","$firebase","AuthService","UserService","AppFirebase","Notification","FBURL","AUTH_EVENTS",function(a,b,c,d,e,f,g,h,i,j,k,l){if(b.appLoaded=null,b.currentUser=null,a.currentGroupId=0,angular.isDefined(c.search().token)){b.appLoaded=!0;var m=c.search().token;c.url(c.path());{i.authenticate(m).then(function(a){g.manualLogin(a.uid,m,"apps").then(function(a){b.currentUser=a.data},function(a){console.log("Login failed:",a)})},function(a){console.error("Login failed:",a)})}}else g.check()&&null!==i.getAuthRef().$getAuth()?(b.appLoaded=!0,g.user("apps").then(function(a){b.currentUser=a.data})):(g.login(),j.showModal("Please log in","#modal-content-login"));b.$watch("currentUser",function(a,b){null===b||!angular.isUndefined(a)&&null!==a?null!==b&&j.hideModal():j.showModal("Please log in","#modal-content-login")}),a.$on(l.notAuthenticated,function(){g.expire(),b.currentUser=null,g.login()}),b.setCurrentUser=function(a){b.currentUser=a},b.logOutCurrentUser=function(){b.currentUser=null,g.logout()},b.logIn=function(){g.check()||g.login()},b.toggleMainDrawer=function(){document.querySelector("unl-layout").toggleDrawer()},b.closeMainDrawer=function(){document.querySelector("unl-layout").closeDrawer()},b.showLoginWindow=function(){j.setModalContent("#modal-content-login")},b.closeModal=function(){j.hideModal()},b.go=function(a,e){b.pageAnimationClass="undefined"==typeof e?"animate-slide-right":e,"back"===a?(b.pageAnimationClass="animate-slide-left",d.history.back()):c.path(a)}}]),angular.module("hyenaAppsApp").controller("DashboardCtrl",["$rootScope","$scope","$routeParams","GroupService","Notification",function(){}]),angular.module("hyenaAppsApp").service("UserService",["APIPATH","APIKEY","$http","toArrayFilter",function(a,b,c,d){return{get:function(d,e){return angular.isUndefined(e)&&(e=""),c.get(a+"users/"+d+"?with="+e+"&api_key="+b)},validate:function(d){return c.post(a+"users/validate?api_key="+b,{ids:[d]})},getUserRelations:function(e,f){if(angular.isUndefined(e))return!1;angular.isUndefined(f)&&(f="user"),e=d(e);for(var g=[],h="",i=0;i<e.length;i++)g.push(e[i][f]),h+=e[i][f]+",";h=h.substring(0,h.length-1);var j=c.get(a+"users?ids="+h+"&api_key="+b);return j.then(function(a){for(var b=0;b<a.data.length;b++)e[b][f]=a.data[b]}),e}}}]),angular.module("hyenaAppsApp").service("Session",["AppFirebase",function(){return{has:function(a){return!!sessionStorage.getItem(a)},get:function(a){return sessionStorage.getItem(a)},set:function(a,b){return sessionStorage.setItem(a,b)},unset:function(a){return sessionStorage.removeItem(a)},createAuthSession:function(a,b){return sessionStorage.setItem("auth",!0),sessionStorage.setItem("authUser",a),sessionStorage.setItem("authToken",b),!0},destroyAuthSession:function(){sessionStorage.removeItem("auth"),sessionStorage.removeItem("authUser"),sessionStorage.removeItem("authToken")}}}]),angular.module("hyenaAppsApp").service("AuthService",["$http","$sessionStorage","$localStorage","UserService","APIKEY","APIPATH","AppFirebase",function(a,b,c,d,e,f,g){var h=g.getRef(),i={login:function(){b.currentRoute=window.location.href,window.location.replace(f+"users/login?api_key="+e+"&callback="+window.location.href)},manualLogin:function(a,b,c){angular.isUndefined(c)&&(c="");var e=d.get(a,c);return e.then(function(){return i.createAuthSession(a,b)?i.user(c):!1})},logout:function(){i.expire(),window.location.replace(f+"users/logout?api_key="+e)},createAuthSession:function(a,b){return c.auth=!0,c.authUser=a,c.authToken=b,!0},user:function(a){angular.isUndefined(a)&&(a="");var b=i.userId();return d.get(b,a)},userId:function(){return c.auth?c.authUser:!1},authToken:function(){return c.authToken},check:function(){return!!c.auth},expire:function(){angular.isDefined(h)&&h.unauth(),delete c.auth,delete c.authUser,delete c.authToken}};return i}]),angular.module("hyenaAppsApp").factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS",function(a,b,c){return{responseError:function(d){return a.$broadcast({401:c.notAuthenticated,403:c.notAuthorized,419:c.sessionTimeout,440:c.sessionTimeout}[d.status],d),b.reject(d)}}}]),angular.module("hyenaAppsApp").service("Notification",function(){var a={show:function(a,b){var c=document.querySelector("unl-toast");c.setAttribute("text",a),c.setAttribute("type",b),c.show()},showModal:function(a,b){var c=document.querySelector("#unl-modal"),d=document.querySelector(b);c.setAttribute("heading",a),c.contents=d,c.show()},hideModal:function(){var a=document.querySelector("#unl-modal");a.close()},setModalContent:function(a){var b=document.querySelector("#unl-modal"),c=document.querySelector(a);b.contents=c}};return a}),angular.module("hyenaAppsApp").service("GroupService",["APIPATH","APIKEY","$http","$firebase","AppFirebase",function(a,b,c,d,e){var f=e.getRef().child("groups"),g={get:function(d,e){return angular.isUndefined(e)&&(e=""),c.get(a+"groups/"+d+"?with="+e+"&api_key="+b)},exists:function(a){var b=d(f.child(a)).$asObject();return b.$loaded(function(){return null!==b.$value})},add:function(a,b){return d(f).$set(b,a)},addUser:function(d,e){return c.post(a+"groups/"+d+"/users?api_key="+b,{users:[e]})},hasUser:function(d,e){return c.get(a+"groups/"+d+"/users/"+e+"?api_key="+b)},existsOrAdd:function(a){var b=g.exists(a);b.then(function(b){if(!b){var c=g.get(a);c.then(function(b){var c={title:b.data.title,description:b.data.description};g.add(c,a).then(function(a){console.log("Group added to Firebase",a)})})}})}};return g}]),angular.module("hyenaAppsApp").service("AppService",["$http","$upload","PLATFORM_ROOT","AuthService",function(a,b,c,d){var e="?token="+d.authToken();return{get:function(b){return a.get(c+"apps/"+b+e)},update:function(b,d){return a.put(c+"apps/"+b+e,d)},add:function(b){return a.post(c+"apps"+e,b)},remove:function(b){return a.delete(c+"apps/"+b+e)},uploadImage:function(a,d){return b.upload({url:c+"apps/"+a+"/image"+e,method:"POST",file:d})}}}]),angular.module("hyenaAppsApp").filter("user",["UserService",function(a){var b=function(b){a.getUserRelations(b);return b};return b.$stateful=!0,b}]),angular.module("hyenaAppsApp").filter("toArray",function(){return function(a){return a instanceof Object?Object.keys(a).map(function(b){return Object.defineProperty(a[b],"$key",{enumerable:!1,value:b})}):a}}),angular.module("hyenaAppsApp").directive("user",["UserService",function(a){return{restrict:"A",scope:{userValue:"=userModel"},link:function(b){b.userValue;b.$watch("userValue",function(c){angular.isDefined(c)&&!angular.isObject(c)&&a.get(c).then(function(a){b.userValue=a.data})})}}}]),angular.module("hyenaAppsApp").controller("AppCtrl",["$scope","$routeParams","AppService","Notification","PLATFORM_ROOT",function(a,b,c,d,e){var f=parseInt(b.appId);c.get(f).then(function(b){a.app=b.data}),a.uploadTarget=e+"apps/"+f+"/image",a.$watch("app",function(b,c){angular.isDefined(c)&&null!==b&&b!==c&&a.updateApp()},!0),a.$watch("app_icon_file",function(b){if(angular.isDefined(b)){console.log(b[0]);var e=c.uploadImage(f,b[0]);e.progress(function(a){console.log("progress: "+parseInt(100*a.loaded/a.total)+"% file :"+a.config.file.name)}).success(function(b){a.app.icon_url=b.uploaded_file;for(var c=0;c<a.currentUser.apps.length;c++)if(a.currentUser.apps[c].id===f){a.currentUser.apps[c].icon_url=b.uploaded_file;break}}).error(function(a){d.show("Sorry! There was an error uploading that image.","error"),console.log("Icon upload failed:",a)})}}),a.updateApp=function(){c.update(f,a.app).then(function(){for(var b=0;b<a.currentUser.apps.length;b++)if(a.currentUser.apps[b].id===f){a.currentUser.apps[b]=a.app;break}},function(){d.show("Sorry! There was an error updating your app.","error")})},a.removeApp=function(){c.remove(f).then(function(){for(var b=0;b<a.currentUser.apps.length;b++)if(a.currentUser.apps[b].id===f){a.currentUser.apps.splice(b,1);break}a.go("/","animate-slide-left"),d.show("Your app has been removed.","success")},function(a){console.log("Error removing app",a),d.show("Sorry! There was an error removing your app.","error")})}}]),angular.module("hyenaAppsApp").controller("NewCtrl",["$scope","AppService","Notification",function(a,b,c){a.app={},a.createApp=function(){b.add(a.app).then(function(b){var d=b.data.id;a.app.active=1,a.currentUser.apps.push(a.app),a.go("app/"+d),c.show("Your app has been created successfully!","success")},function(a){console.log("Create App Error",a),c.show("There was an error creating your app.","error")})}}]);